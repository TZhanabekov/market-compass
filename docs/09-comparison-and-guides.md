# Comparison & Guides

## Comparison is SKU-consistent
All comparisons must use the **same Golden SKU**:
- Local market price for SKU (home country)
- Destination deal price for SKU (ranked offer)

### Comparison computations
- `savings_usd = local_effective_usd - destination_effective_usd`
- `savings_percent = savings_usd / local_effective_usd * 100`
- Show components:
  - tax refund estimate used
  - shipping used
  - warning if any component is unknown

### Compatibility checks
Comparison must include “can I use this iPhone?” caveats:
- SIM variant differences (eSIM only vs nanoSIM)
- lock state (unlocked vs locked)
- region caveats (bands, mmWave, regulatory differences)
- warranty caveats (region-limited)

## Guides: generated, factual, compact

### Core constraint
Guides are generated by LLM **only from facts** retrieved from a **whitelist of sources**.
No open-web reasoning at request time.

### Two-layer model

#### Layer A — Country Facts (structured)
A strict JSON schema with fields such as:
- eligibility requirements (who can claim, thresholds)
- export/validation steps (where/when)
- deadlines (time window)
- refund modes (refund at purchase vs later)
- operator fees (if reliably known)
- airport-specific notes (optional)

Each field must carry:
- citations: one or more source URLs
- extracted timestamp
- confidence and “unknown” markers

#### Layer B — UI Guide Steps
From Country Facts + SKU caveats we generate:
- 3–7 steps (title, 1–2 lines description, icon name)
- 0–2 critical alerts (short, scary-but-accurate)

### Prompting strategy (Extract -> Compose)

#### Prompt 1: ExtractFacts
Input:
- raw text snippets from whitelist sources
- country code and scope (tax-free for electronics)
Output:
- structured JSON facts
Rules:
- never invent
- if not present -> null + reason
- attach citations per field

#### Prompt 2: ComposeGuideSteps
Input:
- facts JSON
- language code
- UI constraints (max steps, tone, icons)
Output:
- guideSteps[]
- alerts[]
- freshness status

### Freshness and versioning
- facts have `facts_version` and `last_verified_at`
- guides reference `facts_version`
- if facts are stale:
  - mark status = `stale`
  - optionally schedule refresh
  - still render steps but show “last verified” in UI if desired

## Storage
- `country_sources`: whitelist URLs
- `country_facts_versions`: extracted facts + citations
- `country_guides_versions`: UI steps per language

## Where guides are applied in UI
- DealCard expanded view shows:
  - `restrictionAlert` (SKU + country)
  - `guideSteps[]` (country-specific)
- ComparisonModal can reuse:
  - the destination country guide steps
  - plus 1 compatibility alert if needed
