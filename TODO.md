# Market Compass ‚Äî –ü–ª–∞–Ω —Ä–∞–±–æ—Ç –∏ ToDo

> –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –ó–∞–¥–∞—á–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

---

## üõ† –¶–µ–ª–µ–≤–æ–π —Å—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

### Frontend
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **Next.js 16** ‚úÖ | SSR/ISR, Edge Runtime –¥–ª—è –≥–µ–æ-–ª–æ–≥–∏–∫–∏ |
| **Vercel** | –•–æ—Å—Ç–∏–Ω–≥, Edge Functions, Analytics |
| **Tailwind CSS 4** ‚úÖ | –°—Ç–∏–ª–∏ |
| **shadcn/ui** ‚úÖ | UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã |
| **Zod** | –í–∞–ª–∏–¥–∞—Ü–∏—è API –æ—Ç–≤–µ—Ç–æ–≤ |

### Backend
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **FastAPI** (Python 3.11+) ‚úÖ | REST API |
| **Docker** ‚úÖ | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è |
| **Railway** | –î–µ–ø–ª–æ–π, –∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥ |
| **Pydantic v2** ‚úÖ | –°—Ö–µ–º—ã –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤ |

### –î–∞–Ω–Ω—ã–µ –∏ –∫–µ—à
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **PostgreSQL** (Neon / Supabase) | –û—Å–Ω–æ–≤–Ω–∞—è –ë–î |
| **Upstash Redis** | –ö–µ—à SerpAPI (TTL —á–∞—Å—ã), –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç |
| **openexchangerates API** | –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç (TTL ~1 —á–∞—Å) |
| **Cloudflare CDN** | –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Å—Å–µ—Ç–æ–≤, –∑–∞—â–∏—Ç–∞ |

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Å–µ—Ä–≤–∞–±–∏–ª–∏—Ç–∏
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **GitHub Actions** | CI/CD |
| **Vitest** | Unit —Ç–µ—Å—Ç—ã |
| **Playwright** | E2E —Ç–µ—Å—Ç—ã |
| **Sentry** | Error tracking |
| **Checkly** | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ API/uptime |
| **Vercel Analytics** | Web analytics |

### LLM-—Å–ª–æ–π
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **GPT-4o-mini** | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (—Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏), –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ |

---

## ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã

### Phase 0.1 ‚Äî –ú–∏–≥—Ä–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ Next.js ‚úÖ
- [x] –°–æ–∑–¥–∞–Ω Next.js 16 –ø—Ä–æ–µ–∫—Ç —Å App Router –≤ `apps/web`
- [x] –ù–∞—Å—Ç—Ä–æ–µ–Ω Tailwind CSS 4 —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ç–µ–º–æ–π iPassport
- [x] –ù–∞—Å—Ç—Ä–æ–µ–Ω shadcn/ui (button, card, dialog, slider, etc.)
- [x] –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
  - [x] Header, HeroSection, ModelSelector
  - [x] CompareCard, ComparisonModal
  - [x] Leaderboard, DealCard
  - [x] RiskSlider, TrustMeter, AnimatedNumber
  - [x] LocationModal
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã "use client" –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [x] –ü—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

### Phase 0.2 ‚Äî –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—ç–∫–µ–Ω–¥–∞ ‚úÖ
- [x] –°–æ–∑–¥–∞–Ω FastAPI backend –≤ `services/api`
- [x] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
  - [x] `app/main.py` ‚Äî FastAPI instance, middleware, lifespan
  - [x] `app/settings.py` ‚Äî Pydantic Settings
  - [x] `app/routes/ui.py` ‚Äî GET /v1/ui/home
  - [x] `app/routes/redirect.py` ‚Äî GET /r/offers/{offerId}
  - [x] `app/services/` ‚Äî ranking, dedup, trust, hydration, serpapi_client
  - [x] `app/stores/` ‚Äî postgres, redis
  - [x] `app/models/` ‚Äî GoldenSku, Merchant, Offer
  - [x] `app/schemas/` ‚Äî HomeResponse, Deal, etc.
- [x] Docker Compose –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
  - [x] FastAPI app
  - [x] PostgreSQL 16
  - [x] Redis 7
- [x] Dockerfile –¥–ª—è FastAPI (multi-stage build)
- [x] –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (health, home endpoint)

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
apps/
‚îú‚îÄ‚îÄ web/               # ‚úÖ Next.js 16 (–æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)
‚îî‚îÄ‚îÄ api/               # Node.js/Fastify –ø—Ä–æ—Ç–æ—Ç–∏–ø (deprecated, –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞)

services/
‚îî‚îÄ‚îÄ api/               # ‚úÖ FastAPI backend (–æ—Å–Ω–æ–≤–Ω–æ–π)
    ‚îú‚îÄ‚îÄ app/
    ‚îÇ   ‚îú‚îÄ‚îÄ main.py
    ‚îÇ   ‚îú‚îÄ‚îÄ settings.py
    ‚îÇ   ‚îú‚îÄ‚îÄ routes/
    ‚îÇ   ‚îú‚îÄ‚îÄ services/
    ‚îÇ   ‚îú‚îÄ‚îÄ stores/
    ‚îÇ   ‚îú‚îÄ‚îÄ models/
    ‚îÇ   ‚îî‚îÄ‚îÄ schemas/
    ‚îú‚îÄ‚îÄ alembic/       # ‚úÖ Database migrations
    ‚îÇ   ‚îî‚îÄ‚îÄ versions/
    ‚îú‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îî‚îÄ‚îÄ pyproject.toml
```

---

## üîÑ –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏

### Phase 1 ‚Äî Backend API (–ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)

#### 1.1 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)
- [x] SQLAlchemy models:
  - [x] `golden_skus`
  - [x] `merchants`
  - [x] `offers`
- [x] Alembic –º–∏–≥—Ä–∞—Ü–∏–∏ (async PostgreSQL support)
- [x] Seed –¥–∞–Ω–Ω—ã–µ: Golden SKU –¥–ª—è iPhone 16 Pro/Max + sample offers

#### 1.2 Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–µ—à–∞ (TTL –ø–æ–ª–∏—Ç–∏–∫–∏)
- [x] Locks –¥–ª—è hydration (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ thundering herd)
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Upstash Redis (production)
- [x] –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è env: `CORS_ORIGINS` (+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å `ALLOWED_ORIGINS`), `SERPAPI_API_KEY` (+ `SERPAPI_KEY`), `AUTO_MIGRATE` –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö
- [x] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Upstash Redis (TLS CA certs –≤ Docker + Redis ping/—Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ —Å—Ç–∞—Ä—Ç–µ)
- [x] Startup health-–ª–æ–≥–∏: —è–≤–Ω—ã–µ `Postgres connected` / `Redis connected` –≤ deploy output

#### 1.3 API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- [x] `GET /health`
- [x] `GET /v1/ui/home?sku=...&home=...&minTrust=...&lang=...`
- [x] `GET /r/offers/{offerId}` ‚Äî redirect
- [x] API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ PostgreSQL

#### 1.4 –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å openexchangerates API (FX service)
- [ ] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis (TTL ~1 —á–∞—Å)
- [x] –î–æ–±–∞–≤–ª–µ–Ω FX —Å–µ—Ä–≤–∏—Å + Redis cache helpers (–≥–æ—Ç–æ–≤–æ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –≤ ingestion/–ø–µ—Ä–µ—Å—á—ë—Ç price_usd)
- [x] Debug endpoint: `/v1/admin/debug/fx` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫—É—Ä—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä EUR)

---

## Phase 2 ‚Äî SerpAPI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- [x] SerpAPI –∫–ª–∏–µ–Ω—Ç (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è google_shopping + immersive)
- [x] –†–µ–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã SerpAPI (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ Redis, TTL 1-6h)
- [x] Fix: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã –¥–ª—è `extracted_price` (–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `alternative_price.currency`, –µ—Å–ª–∏ primary price –≤ –¥—Ä—É–≥–æ–π –≤–∞–ª—é—Ç–µ)
- [x] Regex extraction –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤ iPhone (model/storage/color/condition)
- [ ] GPT-4o-mini fallback –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (low-confidence)
- [x] Trust Score (0-100) ‚Äî –±–∞–∑–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
- [x] Ranking –ø–æ effective price
- [x] Ingestion service: SerpAPI ‚Üí extraction ‚Üí FX ‚Üí dedup ‚Üí DB
- [x] Admin endpoint: `POST /v1/admin/ingest` –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] Scheduled refresh jobs (worker)
- [ ] ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å seed-–¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–∑ SerpAPI

---

## Phase 3 ‚Äî Guides (LLM + whitelist)

- [ ] –¢–∞–±–ª–∏—Ü–∞ `country_sources` (whitelist URLs)
- [ ] Facts Extraction (GPT-4o-mini) ‚Üí structured JSON
- [ ] Guide Composition ‚Üí 3-7 steps + alerts
- [ ] Multi-language –ø–æ–¥–¥–µ—Ä–∂–∫–∞

---

## Phase 4 ‚Äî SEO (Next.js ISR)

- [ ] `/[sku]/[country]` dynamic routes
- [ ] ISR —Å revalidate interval
- [ ] JSON-LD: Product + AggregateOffer
- [ ] hreflang tags

---

## Phase 5 ‚Äî Admin & Observability

- [ ] Admin panel –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - [ ] iPhone models (16 Pro, 16 Pro Max, –±—É–¥—É—â–∏–µ –º–æ–¥–µ–ª–∏)
  - [ ] Golden SKUs (storage/color/condition –≤–∞—Ä–∏–∞–Ω—Ç—ã)
  - [ ] Merchants (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è, blacklist)
- [ ] Review queue –¥–ª—è low-confidence matches
- [ ] Sentry + Checkly + Vercel Analytics

---

## üöÄ –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---|--------|-----------|
| 1 | ~~–ó–∞–ø—É—Å—Ç–∏—Ç—å docker-compose, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å API~~ ‚úÖ | Done |
| 2 | ~~–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Alembic –º–∏–≥—Ä–∞—Ü–∏–∏~~ ‚úÖ | Done |
| 3 | ~~Seed –¥–∞–Ω–Ω—ã–µ –¥–ª—è Golden SKU + iPhone 16 Pro~~ ‚úÖ | Done |
| 4 | ~~–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫ API (react-query)~~ ‚úÖ | Done |
| 5 | ~~–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Railway deployment~~ ‚úÖ | Done |
| 6 | –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Railway (–≤—Ä—É—á–Ω—É—é –∏–ª–∏ AUTO_MIGRATE=true) | üü° Medium |
| 7 | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Neon/Supabase PostgreSQL (production) | üü° Medium |
| 8 | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Upstash Redis (production) | üü° Medium |
| 9 | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å NEXT_PUBLIC_API_URL –¥–ª—è production (Railway URL) | üü° Medium |

---

## –ó–∞–º–µ—Ç–∫–∏

- ‚úÖ Frontend –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ Next.js 16 + Tailwind 4
- ‚úÖ FastAPI backend —Å–æ–∑–¥–∞–Ω –≤ `services/api`
- ‚úÖ Docker Compose –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ pnpm –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ package manager
- –ü—Ä–æ—Ç–æ—Ç–∏–ø API (Fastify) –≤ `apps/api/src/index.ts` ‚Äî deprecated, –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞
- Shared Zod schemas –≤ `packages/shared/src/index.ts` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –∫–æ–Ω—Ç—Ä–∞–∫—Ç

## Vercel –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **Root Directory** | `apps/web` |
| **Framework Preset** | Next.js |
| **Build Command** | `pnpm build` |
| **Output Directory** | _(–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)_ |
| **Install Command** | `pnpm install` |

## Railway –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Backend)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **Root Directory** | `services/api` |
| **Builder** | Dockerfile |
| **Port** | 8080 |
